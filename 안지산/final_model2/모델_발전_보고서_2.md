# 📘 모델 발전 보고서 (안지산 – final_model1 → final_model2)

본 문서는 멀티모달 유해 콘텐츠 탐지 모델을 개발하는 과정에서  
`final_model1`에서 `final_model2`로 발전시키는 과정 전반을 정리한 기술 보고서이다.

기록 목적:
- 모델 구조/데이터/라벨링/학습 방식 상의 문제를 발견하고 해결한 과정을 공유
- 설계 의도와 성능 변화 근거를 명확히 문서화하여 프로젝트 진행상황을 투명하게 관리
- 이후 final_model3 개발을 위한 기반 마련

---

# 1. 📌 final_model1 문제 분석

### 👉 요약  
final_model1은 구조적으로는 “멀티모달”을 사용하는 것처럼 보였지만, 실제 동작을 분석한 결과 **학습이 정상적으로 이루어지지 않는 모델**이었다.

### 문제 1) 전처리 clip_id와 라벨 clip_id mismatch  
- 전처리된 클립 ID 예: `RWF-2000/V_123_0.0_4.0`
- 라벨링 파일 key 예: `V_123_0.0_4.0.mp4`
- 경로 구조가 달라서 **라벨 매칭 0건 발생**

→ **train.jsonl / val.jsonl에 label이 제대로 포함되지 않음**

### 문제 2) video/audio/text 입력이 모두 zero tensor  
- clip_path mismatch 때문에 영상 파일을 못 읽음 → video = zeros  
- audio path mismatch → audio = zeros  
- text path mismatch → text = empty  
- 즉, **모델이 실제 데이터를 단 한 번도 학습하지 못함**

### 문제 3) YOLO-based harmful label은 매우 단순  
- “객체 감지 기반 harmful”  
- 행동, 오디오, 텍스트 정보 반영 X  
→ 멀티모달 개념과 맞지 않는 라벨 구조

### 문제 4) 학습 결과  
- 평가 지표: acc≈0.90, F1=0  
- harmful을 단 한 번도 예측하지 않음  
- 모델이 모든 샘플을 safe(0)로만 예측하는 상태

📌 결론:   
**final_model1은 데이터 정합·입력·라벨·모델 모두 비정상적인 상태였고, 학습 불가능한 구조였다.**

---

# 2. 📌 final_model2 설계 목표

final_model2의 목표는 다음과 같았다.

1. **멀티모달 입력을 정상적으로 사용하도록 전처리/로더 재설계**
2. **라벨링 파일과 전처리 파일을 100% 정합되게 병합**
3. **video/audio/text encoder를 실제 forward 가능하게 재설계**
4. **단일 harmful 분류를 중심으로 학습 구조 단순화**
5. **InfoNCE 제거하여 classification에 집중**
6. **threshold 기반 평가 구조 개선**

---

# 3. 📌 핵심 개선 내용

## 3-1. 전처리 병합 로직 완전 재작성 (split_manifest.py)
### 문제 해결
- 기존: clip_id mismatch로 매칭 실패 → 라벨 0건
- 개선: `clip_path`에서 **파일명.mp4를 추출하여 라벨링 키와 일치시킴**

### 결과
- 총 5,874개 clip 중 **5,874개 전부 label 매칭 성공**
- train: 4,770  
- val: 1,104  

---

## 3-2. dataset_avt.py 재구현
### 개선 내용
- video 정상 로딩 (Decord)
- audio 정상 로딩 (SoundFile + torchaudio)
- text 정상 로딩 (KoBERT tokenizer)
- harmful 라벨 로딩 로직 통일

---

## 3-3. 모델 구조 완전 재설계 (model_avt.py)

### 구성 요소
- **VideoEncoder** – 3D Conv 기반
- **AudioEncoder** – 1D Conv 기반
- **TextEncoder** – KoBERT CLS Embedding + projection
- **Fusion Head** – (video + audio + text)
- **Classifier** – BCE with logits

### 제거한 요소
- InfoNCE(contrastive loss)  
-> early-stage에는 classification 방해됨

---

## 3-4. 학습 코드 재작성 (train.py)

### 주요 포인트
- 텍스트 인코더를 확실하게 freeze
- BCE + threshold 기반 평가
- GPU 안정화 및 tensor shape 정규화

---

# 4. 📌 threshold 최적화 과정 (optimize_threshold.py)

### 배경
- harmful 비율이 7~8%로 낮음  
- sigmoid 출력이 전체적으로 낮은 범위(0.05~0.30)에 집중됨  
- threshold=0.5 → harmful 예측 0회 → F1=0

### 해결
threshold를 sweep(0.01~0.99)하여  
F1-score가 최대가 되는 최적 threshold를 탐색하는 코드를 구현.

### 결과
Best Threshold = 0.120
Best F1 = 0.3557


→ 모델은 실제로 harmful/safe를 어느 정도 구분할 수 있었고  
→ threshold가 문제였다는 것이 확인됨

---

# 5. 📌 final_model2 성능 결과

단 1 epoch 학습 기준:

| 지표 | 값 |
|------|----|
| Accuracy | 0.74 |
| F1-score | 0.205 |
| AUROC | 0.6626 |

### 해석
- F1=0 → F1=0.205로 **성능이 유의미하게 개선됨**
- AUROC>0.65 → harmful/safe 패턴을 모델이 구분할 수 있음
- threshold 조정/고급 loss 적용 여지가 많음

---

# 6. 📌 성능 상승 전략 (final_model3 계획)

final_model2의 한계를 보완하기 위해  
다음 단계에서는 Focal Loss를 도입하여  
harmful에 대한 분류 감도를 향상시키고자 한다.

### final_model3 계획
- Focal Loss (alpha=0.25, gamma=2.0)
- pos_weight 기반 BCE 대체 가능
- harmful oversampling(optional)
- threshold 최적화 결합
- 필요 시 Video backbone 교체 (MoViNet/X3D)

---

# 7. 📌 결론

final_model2는 다음을 달성했다:

- **데이터–라벨 100% 정합**
- **멀티모달 구조 정상화**
- **실제 학습 가능한 모델 구축**
- **F1=0 완전 해결 → F1≈0.20 확보**
- **AUROC 상승을 통해 분류 가능성 확인**

final_model1의 치명적 문제를 모두 제거하고  
final_model3으로 확장 가능한 **안정적인 멀티모달 harmful detection 모델 기반**을 만들었다.

---

📌 *본 보고서는 final_model3 및 최종발표 자료로 확장 가능하며,  
필요 시 시각화/실험 로그/에러 분석 등을 추가할 수 있다.*
