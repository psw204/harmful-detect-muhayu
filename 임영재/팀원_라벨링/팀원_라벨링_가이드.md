# 무하유 팀원용 데이터 라벨링 가이드

---

## 사전 준비

### 1. Python 패키지 설치
```bash
# 필수 패키지 설치
pip install ultralytics opencv-python numpy
```

### 2. 파일 다운로드
- `team_labeling_tool.py` 파일을 다운로드

---

## 폴더 구조 설정

### 1. 기본 폴더 구조 생성
수집한 데이터를 다음과 같이 정리하세요:

```
팀원_데이터/
├── 이미지/              # 유해 이미지 100개를 여기에 저장
│   ├── image_001.jpg
│   ├── image_002.jpg
│   └── ...
│
├── 안전_이미지/         # 안전 이미지 100개를 여기에 저장
│   ├── safe_001.jpg
│   ├── safe_002.jpg
│   └── ...
│
├── 비디오/              # 유해 비디오 100개를 여기에 저장
│   ├── video_001.mp4
│   ├── video_002.mp4
│   └── ...
│
├── 안전_비디오/         # 안전 비디오 100개를 여기에 저장
│   ├── safe_video_001.mp4
│   ├── safe_video_002.mp4
│   └── ...
│
└── 라벨_결과/          # 라벨링 결과가 자동 생성됨 (비워둘 것)
```

### 2. `team_labeling_tool.py` 파일 설정 수정

파일 상단의 **설정 부분**을 자신의 환경에 맞게 수정:

```python
# 설정 부분 - 팀원이 수정해야 하는 부분
# 팀원 이름 (출력 파일 구분용)
TEAM_MEMBER_NAME = "안지산"  # ← 여기를 자신의 이름으로 수정! 예: "안지산", "임영재"

# 데이터 폴더 경로 설정
BASE_PATH = './팀원_데이터/'  # ← 필요시 경로 수정
```

**중요**: `BASE_PATH`는 위에서 만든 폴더 구조의 최상위 경로입니다!

---

## 라벨링 도구 실행

### 1. 실행 방법
```bash
python team_labeling_tool.py
```

### 2. 실행 단계별 설명

#### **Step 1: 유해 이미지 검증**
- YOLO가 자동으로 유해 객체를 탐지합니다
- 화면에 이미지와 탐지된 객체(바운딩 박스)가 표시됩니다
- 키보드 입력:
  - **Y** 또는 **Space바**: 유해 콘텐츠로 승인
  - **N**: 안전 콘텐츠 (제외)
  - **Q**: 검증 중단 및 종료

#### **Step 2: 안전 이미지 라벨링**
- 자동으로 처리됩니다 (사용자 입력 불필요)
- 모든 이미지가 안전(label=0)으로 자동 라벨링됩니다

#### **Step 3: 유해 비디오 검증**
- YOLO가 비디오 프레임을 샘플링하여 유해 객체를 탐지합니다
- 화면에 중간 프레임과 탐지 정보가 표시됩니다
- 키보드 입력:
  - **Y** 또는 **Space바**: 유해 콘텐츠로 승인
  - **N**: 안전 콘텐츠 (제외)
  - **Q**: 검증 중단 및 종료

#### **Step 4: 안전 비디오 라벨링**
- 자동으로 처리됩니다 (사용자 입력 불필요)
- 모든 비디오가 안전(label=0)으로 자동 라벨링됩니다

### 3. 출력 결과

실행이 완료되면 `팀원_데이터/라벨_결과/` 폴더에 다음 파일들이 생성됩니다:

```
라벨_결과/
├── verified_labels.json           # 검증된 유해 이미지 라벨
├── safe_labels.json                # 안전 이미지 라벨
├── verified_video_labels.json      # 검증된 유해 비디오 라벨
└── safe_video_labels.json          # 안전 비디오 라벨
```

**이 4개 파일을 팀에 공유하면 됩니다!**

---

## 데이터 통합 방법

각 팀원이 라벨링한 데이터를 모델 학습에 사용하려면, 각자의 모델 학습 코드에서 다음과 같이 팀원 데이터를 로드하면 됩니다.

### 팀원 데이터 폴더 구조
```
통합_데이터/
├── 안지산/
│   ├── 라벨_결과/
│   │   ├── verified_labels.json
│   │   ├── safe_labels.json
│   │   ├── verified_video_labels.json
│   │   └── safe_video_labels.json
│   ├── 이미지/
│   ├── 안전_이미지/
│   ├── 비디오/
│   └── 안전_비디오/
│
├── 임영재/ (동일 구조)
└── 박상우/ (동일 구조)
```

### 데이터 로드 예시 코드

**이미지 데이터 로드:**
```python
import json
import os

def load_team_member_images(member_name, base_path='./통합_데이터/'):
    """팀원 이미지 데이터 로드"""
    images = []
    labels = []
    
    # 유해 이미지 로드
    verified_path = os.path.join(base_path, member_name, '라벨_결과', 'verified_labels.json')
    img_dir = os.path.join(base_path, member_name, '이미지')
    
    if os.path.exists(verified_path):
        with open(verified_path, 'r', encoding='utf-8') as f:
            data = json.load(f)
        for filename, detections in data.items():
            img_path = os.path.join(img_dir, filename)
            if os.path.exists(img_path):
                images.append(img_path)
                labels.append(1 if len(detections) > 0 else 0)  # 탐지 있으면 유해(1)
    
    # 안전 이미지 로드
    safe_path = os.path.join(base_path, member_name, '라벨_결과', 'safe_labels.json')
    safe_dir = os.path.join(base_path, member_name, '안전_이미지')
    
    if os.path.exists(safe_path):
        with open(safe_path, 'r', encoding='utf-8') as f:
            data = json.load(f)
        for filename in data.keys():
            img_path = os.path.join(safe_dir, filename)
            if os.path.exists(img_path):
                images.append(img_path)
                labels.append(0)  # 안전(0)
    
    return images, labels

# 사용 예시
안지산_images, 안지산_labels = load_team_member_images('안지산')
임영재_images, 임영재_labels = load_team_member_images('임영재')
박상우_images, 박상우_labels = load_team_member_images('박상우')

# 모든 데이터 합치기 (총 600개)
all_images = 안지산_images + 임영재_images + 박상우_images
all_labels = 안지산_labels + 임영재_labels + 박상우_labels
```

**비디오 데이터 로드:**
```python
def load_team_member_videos(member_name, base_path='./통합_데이터/'):
    """팀원 비디오 데이터 로드"""
    videos = []
    labels = []
    
    # 유해 비디오 로드
    verified_path = os.path.join(base_path, member_name, '라벨_결과', 'verified_video_labels.json')
    video_dir = os.path.join(base_path, member_name, '비디오')
    
    if os.path.exists(verified_path):
        with open(verified_path, 'r', encoding='utf-8') as f:
            data = json.load(f)
        for filename, info in data.items():
            video_path = os.path.join(video_dir, filename)
            if os.path.exists(video_path):
                videos.append(video_path)
                labels.append(1 if info.get('is_harmful', False) else 0)
    
    # 안전 비디오 로드
    safe_path = os.path.join(base_path, member_name, '라벨_결과', 'safe_video_labels.json')
    safe_dir = os.path.join(base_path, member_name, '안전_비디오')
    
    if os.path.exists(safe_path):
        with open(safe_path, 'r', encoding='utf-8') as f:
            data = json.load(f)
        for filename in data.keys():
            video_path = os.path.join(safe_dir, filename)
            if os.path.exists(video_path):
                videos.append(video_path)
                labels.append(0)
    
    return videos, labels

# 사용 예시
안지산_videos, 안지산_vlabels = load_team_member_videos('안지산')
임영재_videos, 임영재_vlabels = load_team_member_videos('임영재')
박상우_videos, 박상우_vlabels = load_team_member_videos('박상우')

# 모든 데이터 합치기 (총 600개)
all_videos = 안지산_videos + 임영재_videos + 박상우_videos
all_vlabels = 안지산_vlabels + 임영재_vlabels + 박상우_vlabels
```

**핵심 포인트:**
- `verified_labels.json`: 탐지 객체가 있으면 `label=1` (유해), 없으면 `label=0`
- `safe_labels.json`: 모두 `label=0` (안전)
- `verified_video_labels.json`: `is_harmful` 필드 값 사용
- `safe_video_labels.json`: 모두 `label=0` (안전)

---

## 출력 파일 형식 확인

### 1. `verified_labels.json` (유해 이미지)
```json
{
  "knife_001.jpg": [
    {
      "class": "knife",
      "detected_as": "knife",
      "confidence": 0.95,
      "bbox": [100, 150, 300, 400]
    }
  ],
  "gun_002.jpg": [
    {
      "class": "gun",
      "detected_as": "pistol",
      "confidence": 0.92,
      "bbox": [120, 100, 250, 300]
    }
  ]
}
```

### 2. `safe_labels.json` (안전 이미지)
```json
{
  "safe_nature_001.jpg": {
    "is_safe": true,
    "label": 0,
    "category": "safe"
  },
  "safe_food_002.jpg": {
    "is_safe": true,
    "label": 0,
    "category": "safe"
  }
}
```

### 3. `verified_video_labels.json` (유해 비디오)
```json
{
  "video_gun_001.mp4": {
    "duration": 10.5,
    "fps": 30.0,
    "total_frames": 315,
    "sampled_frames": 10,
    "detected_objects": ["knife", "bottle"],
    "total_detections": 5,
    "frame_detections": [...],
    "estimated_action": "shooting",
    "is_harmful": true
  }
}
```

### 4. `safe_video_labels.json` (안전 비디오)
```json
{
  "safe_nature_001.mp4": {
    "is_safe": true,
    "label": 0,
    "category": "safe",
    "duration": 12.3,
    "fps": 30.0,
    "total_frames": 369
  }
}
```

---

## 문제 해결

### Q1. "ultralytics 설치 필요" 에러
```bash
pip install ultralytics
```

### Q2. "opencv-python 설치 필요" 에러
```bash
pip install opencv-python
```

### Q3. 이미지/비디오가 표시되지 않음
- 파일 경로가 올바른지 확인
- 파일 형식 확인:
  - 이미지: `.jpg`, `.png`, `.jpeg`
  - 비디오: `.mp4`

### Q4. 검증 중 실수로 잘못 입력함
- 도구를 다시 실행하면 됩니다
- 이미 저장된 라벨 파일은 덮어씌워집니다

### Q5. 유해 객체가 탐지되지 않음
- YOLO는 학습된 객체만 탐지할 수 있습니다
- 탐지되지 않더라도 **파일명이나 맥락**을 고려하여 수동으로 판단하세요
- 예: 피 묻은 칼 사진인데 탐지 안 됨 → **Y** (유해로 승인)

### Q6. 한글 경로 문제
- 코드에서 `cv2.imdecode`와 `np.fromfile`을 사용하여 한글 경로를 지원합니다
- 그래도 문제가 있다면 영문 경로 사용을 권장합니다

---

## 체크리스트

**라벨링 전:**
- [ ] Python 패키지 설치 완료 (`ultralytics`, `opencv-python`)
- [ ] 폴더 구조 생성 완료
- [ ] 데이터 수집 완료 (이미지 200개, 비디오 200개)
- [ ] `team_labeling_tool.py` 설정 수정 완료 (팀원 이름, 경로)

**라벨링 후:**
- [ ] 유해 이미지 검증 완료
- [ ] 유해 비디오 검증 완료
- [ ] 라벨 파일 4개 생성 확인 (verified_labels.json, safe_labels.json, verified_video_labels.json, safe_video_labels.json)
- [ ] 라벨 파일 및 데이터를 팀에 공유

**데이터 통합 시:**
- [ ] 모든 팀원의 데이터 수집 완료
- [ ] 각자의 모델 코드에 팀원 데이터 로드 코드 추가
- [ ] 공개 데이터셋 + 팀원 600개 데이터로 학습
- [ ] 세 모델의 성능 비교 후 최종 모델 선정

---

**끝!**

